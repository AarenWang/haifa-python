# jq 支持阶段性设计方案

## 背景
当前 `compiler` 子模块提供类汇编→AST→字节码→寄存器虚拟机 的完整流水线，运行时仅支持整数与简单数组操作。目标是在现有 VM 基础上实现与 `jq` 类似的 JSON 过滤能力，为项目提供更强的数据处理场景支持。

## 总体目标
- 扩展 VM 数据模型，使其能原生承载 JSON 值（对象、数组、字符串、数字、布尔、null）。
- 在虚拟机流水线中实现 `jq` 过滤语义（管道、多结果输出、字段访问、迭代、内建函数等）。
- 提供命令行入口，与标准输入/输出对接，兼容常见 `jq` 用法。
- 保持现有类汇编指令集与测试可运行，避免破坏现有功能。

## 非目标
- 不追求 100% 覆盖 `jq` 全部语法/函数，重点围绕常用子集。
- 暂不实现即时编译、并行执行、流式增量 JSON 解析等高级特性。

## 当前架构痛点
1. **类型限制**：`ExecutionContext.val` 与 `BytecodeVM.val` 会将字面量强制转换为整数，数组实现为 `List[int]`，无法保存复杂 JSON。
2. **指令语义不足**：指令集围绕算术与控制流，不具备对象/数组遍历、生成器式输出等能力。
3. **缺少 `jq` 前端**：解析器仅支持行式汇编脚本，不理解 `jq` 表达式。
4. **缺少 CLI 管线**：无统一的命令行入口读取 JSON / 输出结果。

## 分阶段路线图

### 阶段 1：JSON 值基础能力
- **数据抽象**
  - 新增 `JsonValue` 包装（或直接使用 Python 原生类型）并在执行上下文、寄存器、数组存储中应用。
  - 为寄存器引入统一 `ValueSlot`（字典/类），支持字符串/布尔/null。
  - 更新 `ExecutionContext.val` 与 VM 对应方法，区分立即数（字面量）与寄存器引用。
- **指令集调整**
  - 允许 `MOV` 等指令操作非整数值。
  - 更新数组指令以支持通用 JSON 数组。
- **兼容保障**
  - 确保现有算术指令在需要时执行类型检查或显式转换。
- **测试计划**
  - 扩展单元测试覆盖字符串/布尔/null 的寄存器操作与数组读写。
  - 保持现有测试通过。

### 阶段 2：最小可用 `jq` 子集
- **表达式解析器**
  - 定义 `jq` AST 节点（Identity、Field, Literal, ArrayIter, Pipe 等）。
  - 编写递归下降解析器，支持语法：`.`、`.foo`、`.[]`、字符串/数字字面量、简单函数调用（`length`）与管道 `|`。
  - 解析结果既可直接解释，也可映射为类汇编脚本。
- **AST → VM 映射**
  - 约定 VM 寄存器语义：`$in`（当前输入）、`$curr`（当前值）、`$tmpN`（临时值）。
  - 为对象访问/数组迭代新增指令：`OBJ_GET dst src key`、`ITER_ARRAY src dst_body_label dst_end_label`（或通过现有跳转模板展开）。
  - 管道阶段编译为顺序代码块，每个阶段以 `PUSH_RESULT`/`EMIT` 指令驱动输出缓存。
- **运行时机制**
  - 在 VM 侧维护 `current_values` 队列，实现多输出流；`PRINT_JSON` 指令负责序列化。
  - CLI 接口初期仅处理单个 JSON 输入；保留 `--slurp`/`--raw-output` 设计占位。
- **测试计划**
  - 针对解析器：`.foo`, `.items[]`, `.items[] | .name`, `length` 等用例结构化断言。
  - 针对 VM：编译后的脚本运行比对预期 JSON 输出（需构造 fixture JSON）。
  - CLI：模拟标准输入/输出完成端到端测试。

### 阶段 3：扩展特性与优化
- **更多过滤器**
  - 实现 `map`, `select`, `reduce` 等高频函数。
  - 支持比较、逻辑、算术在 JSON 值上的推广。
- **错误与诊断**
  - 改进错误提示：语法错误、类型错误。
  - CLI 增加 `--debug` 输出，便于调试。
- **性能与内存**
  - 引入懒执行或迭代器优化，避免大数组复制。
  - 评估缓存策略（如字段访问路径编译）。
- **文档与示例**
  - 输出用户指南、示例脚本。
- **测试计划**
  - 增加复杂场景测试、压力用例。

## 风险与对策
- **类型系统复杂度提升**：逐步引入类型封装并保持接口一致，配套测试保障。
- **解析器实现成本**：先聚焦核心语法，采用递归下降+操作符优先级方案；必要时引入第三方库但需评估许可。
- **多结果输出语义**：从阶段 2 起引入统一迭代器接口，缩小后续变更范围。

## 近期行动项（起始迭代）
1. 调整执行上下文与 VM 寄存器模型，支持存储任意 JSON 值。
2. 更新基础指令测试，验证字符串/布尔/null 读写正确。
3. 设计 `jq` 解析输出的 AST/字节码结构草稿，为阶段 2 做准备。
